/*
 * TRENTOS Network Stack
 *
 * Copyright (C) 2019-2021, HENSOLDT Cyber GmbH
 */

#pragma once

import <if_OS_ConfigService.camkes>;
#include "SysLogger/camkes/SysLogger.camkes"
#include "os_network_stack/network_stack.camkes"

#define NwStack_INTERFACES \
    /* config server */ \
    uses      if_OS_ConfigService  OS_ConfigServiceServer; \
    dataport  Buf                  cfg_port; \
    consumes  EventServiceReady    configServer_event_ready; \
    /* logger */ \
    SysLogger_CLIENT_DECLARE_CONNECTOR(sysLogger)


//------------------------------------------------------------------------------
// Network Stack Components

#if !defined(NETWORK_TEST_ONE_NIC)

NwStack_COMPONENT_DEFINE(
    NwStack1,
    NIC_DRIVER_RINGBUFFER_SIZE,
    OS_NETWORK_MAXIMUM_SOCKET_NO,
    NwStack_INTERFACES)

#endif // !defined(NETWORK_TEST_ONE_NIC)

NwStack_COMPONENT_DEFINE(
    NwStack2,
    NIC_DRIVER_RINGBUFFER_SIZE,
    OS_NETWORK_MAXIMUM_SOCKET_NO,
    NwStack_INTERFACES)


//------------------------------------------------------------------------------
// Connect a Network Stack to a ConfigServer
#define NETWORK_STACK_CONNECT_CONFIGSERVER(_inst_, _inst_cfg_server_) \
    \
    connection seL4Notification conn_##_inst_##_inst_cfg_server_##_ready( \
        from _inst_cfg_server_.event_ready, \
        to   _inst_.configServer_event_ready); \
    \
    connection seL4RPCCall conn_##_inst_##_##_inst_cfg_server_##_rpc( \
        from _inst_.OS_ConfigServiceServer, \
        to   _inst_cfg_server_.OS_ConfigServiceServer); \
    \
    connection seL4SharedData conn_##_inst_##_##_inst_cfg_server_##_port( \
        from _inst_.cfg_port, \
        to   _inst_cfg_server_.cfg_port);
